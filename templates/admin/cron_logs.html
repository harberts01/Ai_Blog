{% extends "base.html" %}
{% block title %}Cron Job Logs - Admin{% endblock %}
{% block content %}
<div class="py-5 bg-light">
  <div class="container">
    <!-- Header -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Admin</a></li>
        <li class="breadcrumb-item active">Cron Job Logs</li>
      </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h2 mb-1">
          <i class="bi bi-clock-history me-2"></i>Automated Job Execution Logs
        </h1>
        <p class="text-muted mb-0">Monitor scheduled job executions and performance</p>
      </div>
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">
        <i class="bi bi-speedometer2 me-1"></i>Back to Dashboard
      </a>
    </div>

    <!-- Stats Overview -->
    {% if cron_stats %}
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="text-muted small mb-1">Total Executions</div>
            <div class="h3 mb-0">{{ cron_stats.total_executions }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="text-muted small mb-1">Failed Jobs</div>
            <div class="h3 mb-0 {% if cron_stats.failed_count > 0 %}text-danger{% else %}text-success{% endif %}">
              {{ cron_stats.failed_count }}
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="text-muted small mb-1">Success Rate</div>
            <div class="h3 mb-0 text-success">
              {% if cron_stats.total_executions > 0 %}
              {{ "%.1f"|format((cron_stats.total_executions - cron_stats.failed_count) / cron_stats.total_executions * 100) }}%
              {% else %}
              N/A
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center">
            <div class="text-muted small mb-1">Last 7 Days</div>
            <div class="h3 mb-0">
              {% set recent_count = cron_stats.recent_executions | selectattr('status', 'equalto', 'completed') | map(attribute='count') | sum %}
              {{ recent_count }}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Job Type</label>
            <select name="type" class="form-select">
              <option value="">All Jobs</option>
              <option value="generate_posts" {% if job_type == 'generate_posts' %}selected{% endif %}>Post Generation</option>
              <option value="cleanup" {% if job_type == 'cleanup' %}selected{% endif %}>Database Cleanup</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Records to Show</label>
            <select name="limit" class="form-select">
              <option value="25" {% if limit == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary me-2">
              <i class="bi bi-funnel me-1"></i>Apply Filters
            </button>
            <a href="{{ url_for('admin_cron_logs') }}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i>Clear
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Logs Table -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0">
        <h5 class="mb-0">Execution History</h5>
      </div>
      <div class="card-body p-0">
        {% if logs %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Job Type</th>
                <th>Status</th>
                <th>Started At</th>
                <th>Completed At</th>
                <th>Duration</th>
                <th>Results</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
              <tr>
                <td class="text-muted">#{{ log.log_id }}</td>
                <td>
                  {% if log.job_type == 'generate_posts' %}
                  <span class="badge bg-primary">
                    <i class="bi bi-file-earmark-plus me-1"></i>Generate Posts
                  </span>
                  {% elif log.job_type == 'cleanup' %}
                  <span class="badge bg-warning">
                    <i class="bi bi-trash me-1"></i>Cleanup
                  </span>
                  {% else %}
                  <span class="badge bg-secondary">{{ log.job_type }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if log.status == 'completed' %}
                  <span class="badge bg-success">
                    <i class="bi bi-check-circle me-1"></i>Completed
                  </span>
                  {% elif log.status == 'failed' %}
                  <span class="badge bg-danger">
                    <i class="bi bi-x-circle me-1"></i>Failed
                  </span>
                  {% elif log.status == 'started' %}
                  <span class="badge bg-info">
                    <i class="bi bi-hourglass-split me-1"></i>Running
                  </span>
                  {% else %}
                  <span class="badge bg-secondary">{{ log.status }}</span>
                  {% endif %}
                </td>
                <td class="text-muted small">
                  {% if log.started_at %}
                  {{ log.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                  {% else %}
                  -
                  {% endif %}
                </td>
                <td class="text-muted small">
                  {% if log.completed_at %}
                  {{ log.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                  {% else %}
                  -
                  {% endif %}
                </td>
                <td>
                  {% if log.duration_seconds %}
                  <span class="badge bg-light text-dark">{{ log.duration_seconds }}s</span>
                  {% else %}
                  -
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    {% if log.posts_generated > 0 %}
                    <span class="badge bg-primary" title="Posts Generated">
                      <i class="bi bi-file-text me-1"></i>{{ log.posts_generated }}
                    </span>
                    {% endif %}
                    {% if log.spam_deleted > 0 %}
                    <span class="badge bg-warning" title="Spam Comments Deleted">
                      <i class="bi bi-trash me-1"></i>{{ log.spam_deleted }}
                    </span>
                    {% endif %}
                    {% if log.notifications_deleted > 0 %}
                    <span class="badge bg-info" title="Notifications Deleted">
                      <i class="bi bi-bell-slash me-1"></i>{{ log.notifications_deleted }}
                    </span>
                    {% endif %}
                    {% if not log.posts_generated and not log.spam_deleted and not log.notifications_deleted %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </div>
                </td>
                <td>
                  {% if log.error_message %}
                  <button type="button" class="btn btn-sm btn-outline-danger" 
                          data-bs-toggle="modal" 
                          data-bs-target="#errorModal{{ log.log_id }}">
                    <i class="bi bi-exclamation-triangle me-1"></i>View Error
                  </button>
                  
                  <!-- Error Modal -->
                  <div class="modal fade" id="errorModal{{ log.log_id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                          <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>Error Details
                          </h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          <p class="mb-2"><strong>Job ID:</strong> {{ log.log_id }}</p>
                          <p class="mb-2"><strong>Job Type:</strong> {{ log.job_type }}</p>
                          <p class="mb-2"><strong>Time:</strong> {{ log.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                          <hr>
                          <p class="mb-2"><strong>Error Message:</strong></p>
                          <pre class="bg-light p-3 rounded"><code>{{ log.error_message }}</code></pre>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% elif log.details %}
                  <button type="button" class="btn btn-sm btn-outline-secondary" 
                          data-bs-toggle="modal" 
                          data-bs-target="#detailsModal{{ log.log_id }}">
                    <i class="bi bi-info-circle me-1"></i>View Details
                  </button>
                  
                  <!-- Details Modal -->
                  <div class="modal fade" id="detailsModal{{ log.log_id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">
                            <i class="bi bi-info-circle me-2"></i>Execution Details
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          <pre class="bg-light p-3 rounded mb-0"><code>{{ log.details | tojson(indent=2) }}</code></pre>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-5 text-center text-muted">
          <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
          <h5>No Execution Logs Found</h5>
          <p>Automated job logs will appear here once they start running.</p>
          {% if job_type %}
          <a href="{{ url_for('admin_cron_logs') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i>View All Jobs
          </a>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    {% if logs %}
    <div class="mt-3 text-muted text-center">
      Showing {{ logs|length }} execution{{ 's' if logs|length != 1 }} 
      {% if job_type %}for {{ job_type }}{% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
